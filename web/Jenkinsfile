pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: maven
    image: maven:3.9.9-amazoncorretto-21
    command:
    - /bin/sh
    - -c
    - sleep 999999
    resources:
      limits:
        memory: "2Gi"
        cpu: "1000m"
      requests:
        memory: "1Gi"
        cpu: "500m"
    volumeMounts:
    - name: maven-cache
      mountPath: /root/.m2
    - name: workspace
      mountPath: /workspace
    workingDir: /workspace
    
  - name: kaniko
    image: gcr.io/kaniko-project/executor:v1.23.2-debug
    command:
    - /busybox/sh
    - -c
    - sleep 999999
    resources:
      limits:
        memory: "1Gi"
        cpu: "500m"
      requests:
        memory: "512Mi"
        cpu: "250m"
    volumeMounts:
    - name: workspace
      mountPath: /workspace
    workingDir: /workspace
    # KanikoëŠ” íŠ¹ë³„í•œ ê¶Œí•œì´ í•„ìš”í•  ìˆ˜ ìˆìŒ
    securityContext:
      runAsUser: 0
      
  volumes:
  - name: maven-cache
    emptyDir: {}
  - name: workspace
    emptyDir: {}
"""
        }
    }
    
    environment {
        // ì´ë¯¸ì§€ ì´ë¦„ ì„¤ì •
        IMAGE_NAME = 'fdc-dust-web-app'
        IMAGE_TAG = "${env.BUILD_NUMBER}-${env.GIT_COMMIT[0..7]}"
        
        // Maven ì„¤ì • (ë¦¬ì†ŒìŠ¤ ìµœì í™”)
        MAVEN_OPTS = '-Xmx1536m -XX:+UseG1GC'
        
        // Kaniko ì„¤ì •
        KANIKO_CACHE_TTL = '24h'
        KANIKO_VERBOSITY = 'info'
    }
    
    stages {
        stage('Checkout & Setup') {
            steps {
                script {
                    // ë¸”ë¡œê·¸ì—ì„œ ì–¸ê¸‰ëœ jnlp ì»¨í…Œì´ë„ˆ ê²½ë¡œ ë¬¸ì œ í•´ê²°
                    // workspace ê²½ë¡œë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •
                    workingDirectory = sh(script: "pwd", returnStdout: true).trim()
                    echo "Working directory: ${workingDirectory}"
                }
                checkout scm
            }
        }
        
        stage('Maven Build & Test') {
            steps {
                container('maven') {
                    script {
                        // Maven ë¹Œë“œ ìµœì í™”
                        sh '''
                            echo "Starting Maven build with optimized settings..."
                            echo "Java version:"
                            java -version
                            echo "Maven version:"
                            mvn -version
                            
                            # ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ (ìºì‹œ í™œìš©)
                            mvn dependency:go-offline -B
                            
                            # ì»´íŒŒì¼ ë° í…ŒìŠ¤íŠ¸
                            mvn clean compile test -B
                            
                            echo "Maven build completed successfully"
                        '''
                    }
                }
            }
        }
        
        stage('Build Docker Image with Kaniko') {
            steps {
                container('kaniko') {
                    script {
                        sh """
                        # Kaniko í™˜ê²½ í™•ì¸
                        echo "Kaniko executor location:"
                        ls -la /kaniko/executor
                        
                        # ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ í™•ì¸
                        echo "Build context contents:"
                        ls -la /workspace/
                        
                        # Kanikoë¡œ ì´ë¯¸ì§€ ë¹Œë“œ (ë¸”ë¡œê·¸ ëª¨ë²” ì‚¬ë¡€ ì ìš©)
                        /kaniko/executor \\
                            --context=/workspace \\
                            --dockerfile=/workspace/Dockerfile \\
                            --destination=${IMAGE_NAME}:${IMAGE_TAG} \\
                            --destination=${IMAGE_NAME}:latest \\
                            --no-push \\
                            --cache=true \\
                            --cache-ttl=${KANIKO_CACHE_TTL} \\
                            --single-snapshot \\
                            --verbosity=${KANIKO_VERBOSITY} \\
                            --cleanup
                        """
                    }
                }
            }
        }
        
        stage('Image Verification') {
            steps {
                container('kaniko') {
                    script {
                        sh """
                        # ë¹Œë“œëœ ì´ë¯¸ì§€ í™•ì¸ (ë¡œì»¬ì—ì„œ)
                        echo "Docker images built successfully:"
                        echo "- ${IMAGE_NAME}:${IMAGE_TAG}"
                        echo "- ${IMAGE_NAME}:latest"
                        
                        # ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° í™•ì¸ (ê°€ëŠ¥í•œ ê²½ìš°)
                        echo "Build completed at: \$(date)"
                        echo "Git commit: ${env.GIT_COMMIT}"
                        echo "Build number: ${env.BUILD_NUMBER}"
                        """
                    }
                }
            }
        }
    }
    
    post {
        always {
            script {
                def imageName = 'fdc-dust-web-app'
                def imageTag = "${env.BUILD_NUMBER}-${env.GIT_COMMIT[0..7]}"
                def buildDuration = currentBuild.durationString
                
                echo "=========================================="
                echo "Build Summary:"
                echo "Status: ${currentBuild.result ?: 'SUCCESS'}"
                echo "Duration: ${buildDuration}"
                echo "Docker Image: ${imageName}:${imageTag}"
                echo "Git Commit: ${env.GIT_COMMIT}"
                echo "=========================================="
            }
        }
        success {
            script {
                def imageName = 'fdc-dust-web-app'
                def imageTag = "${env.BUILD_NUMBER}-${env.GIT_COMMIT[0..7]}"
                
                echo "ğŸ‰ Build successful!"
                echo "ğŸ“¦ Docker images created:"
                echo "   - ${imageName}:${imageTag}"
                echo "   - ${imageName}:latest"
                echo "ğŸ’¡ Images are built locally (not pushed to registry)"
                echo "ğŸ’° Spot instance optimization applied"
            }
        }
        failure {
            script {
                echo "âŒ Build failed!"
                echo "ğŸ” Check the logs above for details"
                echo "ğŸ’¡ Consider retrying the build"
            }
        }
        unstable {
            script {
                echo "âš ï¸ Build unstable - some tests may have failed"
            }
        }
        cleanup {
            script {
                echo "ğŸ§¹ Cleaning up workspace..."
                cleanWs()
            }
        }
    }
}
