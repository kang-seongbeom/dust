pipeline {
    options {
        timeout(time: 30, unit: 'MINUTES')
        timestamps()
    }
    
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:v1.23.2-debug
    command:
    - /busybox/sh
    - -c
    - sleep 999999
    tty: true
    resources:
      limits:
        memory: "2Gi"
        cpu: "1000m"
      requests:
        memory: "1Gi"
        cpu: "500m"
    volumeMounts:
    - name: workspace
      mountPath: /workspace
    workingDir: /workspace
    # KanikoëŠ” íŠ¹ë³„í•œ ê¶Œí•œì´ í•„ìš”í•  ìˆ˜ ìˆìŒ
    securityContext:
      runAsUser: 0
    # ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë˜ì§€ ì•Šë„ë¡ ì„¤ì •
    lifecycle:
      preStop:
        exec:
          command: ["/bin/sh", "-c", "sleep 10"]
      
  volumes:
  - name: workspace
    emptyDir: {}
"""
        }
    }
    
    environment {
        // ì´ë¯¸ì§€ ì´ë¦„ ì„¤ì •
        IMAGE_NAME = 'fdc-dust-web-app'
        IMAGE_TAG = "0.0.1"
        
        // Kaniko ì„¤ì •
        KANIKO_CACHE_TTL = '24h'
        KANIKO_VERBOSITY = 'info'
    }
    
    stages {
        stage('Checkout & Setup') {
            steps {
                script {
                    workingDirectory = sh(script: "pwd", returnStdout: true).trim()
                    echo "Working directory: ${workingDirectory}"
                }
                checkout scm
            }
        }
        
        stage('Build Docker Image with Kaniko (Multi-stage)') {
            steps {
                container('kaniko') {
                    script {
                        sh """
                        # Kaniko í™˜ê²½ í™•ì¸
                        echo "Kaniko executor location:"
                        ls -la /kaniko/executor
                        
                        # ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ í™•ì¸
                        echo "Build context contents:"
                        ls -la /workspace/
                        echo "Dockerfile contents:"
                        head -20 /workspace/Dockerfile
                        
                        # Dockerfile ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œë¡œ Maven ë¹Œë“œ + ì´ë¯¸ì§€ ìƒì„±
                        echo "Starting multi-stage Docker build with Kaniko..."
                        echo "This will:"
                        echo "1. Build Spring Boot app with Maven (builder stage)"
                        echo "2. Create runtime image with Amazon Corretto (runtime stage)"
                        
                        # Kaniko ì‹¤í–‰ ë° ê²°ê³¼ í™•ì¸
                        if /kaniko/executor \\
                            --context=/workspace \\
                            --dockerfile=/workspace/Dockerfile \\
                            --destination=${IMAGE_NAME}:${IMAGE_TAG} \\
                            --destination=${IMAGE_NAME}:latest \\
                            --no-push \\
                            --cache=true \\
                            --cache-ttl=${KANIKO_CACHE_TTL} \\
                            --single-snapshot \\
                            --verbosity=${KANIKO_VERBOSITY} \\
                            --cleanup; then
                            echo "âœ… Kaniko build completed successfully"
                        else
                            echo "âŒ Kaniko build failed"
                            exit 1
                        fi
                        """
                    }
                }
            }
        }
        
        stage('Image Verification') {
            steps {
                container('kaniko') {
                    script {
                        sh """
                        # ë¹Œë“œëœ ì´ë¯¸ì§€ í™•ì¸
                        echo "âœ… Multi-stage Docker build completed successfully!"
                        echo "ğŸ“¦ Docker images created:"
                        echo "   - ${IMAGE_NAME}:${IMAGE_TAG}"
                        echo "   - ${IMAGE_NAME}:latest"
                        
                        # ë¹Œë“œ ì •ë³´ ì¶œë ¥
                        echo "ğŸ—ï¸ Build process:"
                        echo "   - Stage 1: Maven build (maven:3.9.9-amazoncorretto-21)"
                        echo "   - Stage 2: Runtime image (amazoncorretto:21-alpine)"
                        echo "   - Final image: Spring Boot WAR with non-root user"
                        
                        # ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° í™•ì¸
                        echo "ğŸ“‹ Build metadata:"
                        echo "   - Build completed at: \$(date)"
                        echo "   - Git commit: ${env.GIT_COMMIT}"
                        echo "   - Build number: ${env.BUILD_NUMBER}"
                        echo "   - Image tag: ${IMAGE_TAG}"
                        """
                    }
                }
            }
        }
    }
    
    post {
        always {
            script {
                def imageName = 'fdc-dust-web-app'
                def imageTag = "${env.BUILD_NUMBER}-${env.GIT_COMMIT[0..7]}"
                def buildDuration = currentBuild.durationString
                
                echo "=========================================="
                echo "Build Summary:"
                echo "Status: ${currentBuild.result ?: 'SUCCESS'}"
                echo "Duration: ${buildDuration}"
                echo "Docker Image: ${imageName}:${imageTag}"
                echo "Git Commit: ${env.GIT_COMMIT}"
                echo "=========================================="
            }
        }
        success {
            script {
                def imageName = 'fdc-dust-web-app'
                def imageTag = "${env.BUILD_NUMBER}-${env.GIT_COMMIT[0..7]}"
                
                echo "ğŸ‰ Multi-stage Docker build successful!"
                echo "ğŸ“¦ Docker images created:"
                echo "   - ${imageName}:${imageTag}"
                echo "   - ${imageName}:latest"
                echo "ğŸ—ï¸ Build process:"
                echo "   - Maven build + Docker image creation in single step"
                echo "   - Multi-stage build with Amazon Corretto runtime"
                echo "ğŸ’¡ Images are built locally (not pushed to registry)"
            }
        }
        failure {
            script {
                echo "âŒ Build failed!"
                echo "ğŸ” Check the logs above for details"
                echo "ğŸ’¡ Consider retrying the build"
            }
        }
        unstable {
            script {
                echo "âš ï¸ Build unstable - some tests may have failed"
            }
        }
        cleanup {
            script {
                echo "ğŸ§¹ Cleaning up workspace..."
                cleanWs()
            }
        }
    }
}
